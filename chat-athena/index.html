<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Revolution</title>

    <script>
      const nomeModuloEstatico = 'agente_de_ia_com_n8n';
    </script>

    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
      /* ===== TODO O SEU CSS ORIGINAL PERMANECE AQUI, SEM ALTERAÃ‡Ã•ES ===== */
      :root {
        /* --- CORES PRINCIPAIS --- */
        --chat--color-primary: #7C00FF;
        --chat--color-primary-shade-50: #6B00E6;
        --chat--color-primary-shade-100: #5A00CC;
        --chat--color-secondary: #7C00FF;
        --chat--color-secondary-shade-50: #6B00E6;
        --chat--color-dark: #7C00FF;
        --chat--color-light: #232323;
        --chat--color-white: #232323;
        --chat--color-light-shade-50: #2a2a2a;
        --chat--color-light-shade-100: #333333;
        --chat--color-medium: #404040;
        --chat--color-disabled: #777980;
        --chat--color-typing: #ffffff;

        /* --- LAYOUT E DIMENSÃ•ES --- */
        --chat--border-radius: 16px;
        --chat--window--width: 420px;
        --chat--window--height: 560px;
        --chat--window--border: 1px solid #333333;

        /* --- CONFIGURAÃ‡Ã•ES DE FONTE --- */
        --chat--font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;

        /* --- HEADER (CABEÃ‡ALHO) --- */
        --chat--header--background: #7C00FF;
        --chat--header--color: #ffffff;
        --chat--header--padding: 1.2rem;
        --chat--heading--font-size: 2em;
        --chat--subtitle--font-size: 0.9em;
        --chat--subtitle--line-height: 1.2;

        /* --- MENSAGENS --- */
        --chat--message--bot--background: #333333;
        --chat--message--bot--color: #ffffff;
        --chat--message--bot--border: none;
        --chat--message--user--background: #535353;
        --chat--message--user--color: #ffffff;
        --chat--message--user--border: none;
        --chat--message--pre--background: rgba(255, 255, 255, 0.1);
        --chat--messages-list--padding: 1rem;
        --chat--message--font-size: 1rem;
        --chat--message--padding: 1rem;
        --chat--message--border-radius: 16px;
        --chat--message-line-height: 1.5;
        --chat--message--margin-bottom: 1rem;

        /* --- ÃREA DE INPUT (DIGITAÃ‡ÃƒO) --- */
        --chat--textarea--height: 50px;
        --chat--textarea--max-height: 30rem;
        --chat--input--font-size: inherit;
        --chat--input--border: 0;
        --chat--input--border-radius: 0;
        --chat--input--padding: 0.8rem;
        --chat--input--background: #232323;
        --chat--input--text-color: #ffffff;
        --chat--input--line-height: 1.5;
        --chat--input--placeholder--font-size: inherit;
        --chat--input--border-active: 0;
        --chat--input--left--panel--width: 2rem;

        /* --- BOTÃ•ES GERAIS --- */
        --chat--button--color: #ffffff;
        --chat--button--background: #7C00FF;
        --chat--button--padding: 0.5rem 1rem;
        --chat--button--border-radius: 16px;
        --chat--button--hover--color: #ffffff;
        --chat--button--hover--background: #6B00E6;
        --chat--close--button--color-hover: #7C00FF;

        /* --- BOTÃƒO TOGGLE (ABRIR/FECHAR CHAT) --- */
        --chat--toggle--size: 64px;
        --chat--toggle--width: var(--chat--toggle--size);
        --chat--toggle--height: var(--chat--toggle--size);
        --chat--toggle--border-radius: 50%;
        --chat--toggle--background: #7C00FF;
        --chat--toggle--hover--background: #6B00E6;
        --chat--toggle--active--background: #5A00CC;
        --chat--toggle--color: #ffffff;

        /* --- BOTÃ•ES DE ENVIO E ARQUIVO --- */
        --chat--input--send--button--background: #232323;
        --chat--input--send--button--color: #ffffff;
        --chat--input--send--button--background-hover: #7C00FF;
        --chat--input--send--button--color-hover: #ffffff;
        --chat--input--file--button--background: #232323;
        --chat--input--file--button--color: #7C00FF;
        --chat--input--file--button--background-hover: #333333;
        --chat--input--file--button--color-hover: #6B00E6;
        --chat--files-spacing: 0.25rem;

        /* --- CORPO E RODAPÃ‰ --- */
        --chat--body--background: #232323;
        --chat--footer--background: #232323;
        --chat--footer--color: #ffffff;
      }

      /* ===== CUSTOMIZAÃ‡Ã•ES DE FONTES ===== */

      /* TÃ­tulos e cabeÃ§alhos usam a fonte Montserrat */
      .chat-header h1,
      .chat-header h2,
      .chat-header h3,
      .chat-title,
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Montserrat', sans-serif !important;
        color: #ffffff !important;
        font-weight: 600; /* Semi-bold */
        margin-bottom: 0.1em !important; /* EspaÃ§amento reduzido entre tÃ­tulo e subtÃ­tulo */
        margin-top: 0 !important; /* Remove margem superior */
      }

      /* TÃ­tulo principal com configuraÃ§Ãµes especÃ­ficas */
      .chat-header h1,
      .chat-title {
        font-weight: 600 !important;
        line-height: 1.1 !important; /* Linha mais compacta para o tÃ­tulo */
      }

      /* SubtÃ­tulo com espaÃ§amento otimizado */
      .chat-header p,
      .chat-subtitle {
        font-family: 'Montserrat', sans-serif !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        margin-top: 0 !important; /* Remove margem superior */
        margin-bottom: 0.5em !important; /* Margem inferior reduzida */
      }

      /* Textos gerais usam a fonte Poppins */
      .chat-message,
      .chat-input,
      .chat-body,
      p, span, div, input, textarea {
        font-family: 'Poppins', sans-serif !important;
        color: #ffffff !important;
      }

      /* ===== CUSTOMIZAÃ‡Ã•ES ESPECÃFICAS ===== */

      /* Cor do texto placeholder (texto de ajuda no input) */
      input::placeholder,
      textarea::placeholder {
        color: #999999 !important; /* Cinza mais suave para melhor legibilidade */
        opacity: 1;
      }

      /* Largura das mensagens aumentada para melhor aproveitamento do espaÃ§o */
      .chat-message {
        max-width: 80% !important; /* Aumentado de 50% para 80% */
        color: #ffffff !important;
      }

      /* Especificamente para mensagens do bot (agente) */
      .chat-message--bot,
      .chat__message--bot {
        max-width: 80% !important;
      }

      /* ===== SCROLLBAR CUSTOMIZADA ===== */
      /* Barra de rolagem personalizada para combinar com o tema */
      ::-webkit-scrollbar {
        width: 8px; /* Largura da barra de rolagem */
      }

      ::-webkit-scrollbar-track {
        background: #232323; /* Fundo da trilha da barra de rolagem */
      }

      ::-webkit-scrollbar-thumb {
        background: #7C00FF; /* Cor da barra de rolagem (roxo) */
        border-radius: 6px; /* Arredondamento da barra */
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #6B00E6; /* Cor da barra ao passar o mouse */
      }

      /* ===== CUSTOMIZAÃ‡Ã•ES DO BOTÃƒO TOGGLE ===== */

      /* BotÃ£o para abrir o chat com texto personalizado */
      .chat__toggle {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: auto !important;
        min-width: 180px !important; /* Largura mÃ­nima para acomodar o texto */
        border-radius: 30px !important; /* BotÃ£o oval */
        padding: 0 20px !important; /* EspaÃ§amento interno horizontal */
        font-family: 'Poppins', sans-serif !important;
      }

      /* Ãcone dentro do botÃ£o toggle */
      .chat__toggle svg {
        display: inline-block !important;
        margin-right: 10px !important; /* EspaÃ§amento entre Ã­cone e texto */
        width: 24px !important;
        height: 24px !important;
      }

      /* Texto que aparece no botÃ£o toggle */
      .chat__toggle::after {
        content: "Tire DÃºvidas com IA"; /* Texto exibido no botÃ£o */
        display: inline-block;
        color: white;
        font-size: 14px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif !important;
      }

      /* ===== ELEMENTOS OCULTOS ===== */

      /* Esconde o botÃ£o "Get Started" caso showWelcomeScreen seja true */
      .chat__welcome-screen-button {
        display: none !important;
      }

      /* SOLUÃ‡Ã•ES ROBUSTAS PARA ESCONDER "Powered by n8n" */

      /* MÃ©todo 1: Esconde o texto por seletor mais especÃ­fico */
      .chat__footer > span,
      .chat__footer span,
      span.svelte-15j5n1q { /* Seletor especÃ­fico gerado pelo Svelte */
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        font-size: 0 !important;
      }

      /* MÃ©todo 2: Esconde por conteÃºdo de texto */
      span:has-text("Powered by"),
      span:has-text("n8n") {
        display: none !important;
      }

      /* MÃ©todo 3: Remove altura do rodapÃ© se necessÃ¡rio */
      .chat__footer:empty {
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      /* MÃ©todo 4: ForÃ§a ocultaÃ§Ã£o por posiÃ§Ã£o */
      .chat__footer {
        position: relative !important;
      }

      .chat__footer > * {
        position: absolute !important;
        left: -9999px !important;
        opacity: 0 !important;
      }
    </style>
</head>
<body style="margin: 0;">

    <div id="iarev-chat"></div>

    <script type="module">
      // Importa a biblioteca do N8N Chat
      import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

      /* =======================================
         PREVENÃ‡ÃƒO DE MÃšLTIPLAS INSTÃ‚NCIAS
       ======================================= */
      if (window.__iarevChat) {
        window.__iarevChat.destroy?.();
      }

      /* =======================================
         CONFIGURAÃ‡ÃƒO DE METADADOS
       ======================================= */

      const slugify = (s) =>
        s
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .toLowerCase().replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "_");

      // Objeto de metadados agora comeÃ§a com um valor padrÃ£o, pronto para ser atualizado
      const metadata = {
        modulo: nomeModuloEstatico,
        aula: "aula_geral" // Valor inicial
      };

      // =====================================================================
      //  NOVO: RECEPTOR DE MENSAGENS DA PÃGINA DA CADEMY
      // =====================================================================
      window.addEventListener('message', function(event) {
        // Medida de seguranÃ§a: apenas aceita mensagens de domÃ­nios da Cademy.
        // Para seguranÃ§a mÃ¡xima, troque 'cademy.com.br' pela URL exata da sua escola.
        if (!event.origin.includes('cademy.com.br')) {
            console.warn('Mensagem de origem desconhecida ignorada:', event.origin);
            return;
        }

        // Verifica se a mensagem tem o tipo e os dados que esperamos
        if (event.data && event.data.type === 'setAula') {
          console.log('Nome da aula recebido da Cademy:', event.data.aula);
          
          // Atualiza o nome da aula no nosso objeto metadata
          metadata.aula = slugify(event.data.aula);
        }
      });
      // =====================================================================

      /* =======================================
         FUNÃ‡ÃƒO PARA REMOVER "Powered by n8n"
       ======================================= */
      function removePoweredByN8n() {
        // ... (seu cÃ³digo original aqui, sem alteraÃ§Ãµes)
        const footerElements = document.querySelectorAll('.chat__footer span, .chat__footer > span, span.svelte-15j5n1q');
        footerElements.forEach(el => {
          if (el.textContent.includes('Powered by') || el.textContent.includes('n8n')) {
            el.remove();
          }
        });
        const walker = document.createTreeWalker(document.getElementById('iarev-chat'), NodeFilter.SHOW_TEXT, null, false);
        let node;
        const nodesToRemove = [];
        while (node = walker.nextNode()) {
          if (node.textContent.includes('Powered by n8n')) {
            nodesToRemove.push(node.parentElement);
          }
        }
        nodesToRemove.forEach(el => {
          if (el) el.remove();
        });
        const footer = document.querySelector('.chat__footer');
        if (footer && footer.textContent.includes('Powered by')) {
          footer.innerHTML = '';
          footer.style.display = 'none';
        }
      }

      /* =======================================
         CRIAÃ‡ÃƒO E CONFIGURAÃ‡ÃƒO DO CHAT
       ======================================= */
      window.__iarevChat = createChat({
        target: "#iarev-chat",
        webhookUrl: "/api/chat-proxy",
        metadata, // Este objeto agora Ã© atualizado dinamicamente pela mensagem da Cademy
        showWelcomeScreen: false,
        initialMessages: [
            "OlÃ¡! Sou a Athena, monitora do IA Revolution. Me fala qual Ã© sua pergunta sobre essa aula, que vou te ajudar ðŸ˜„"
        ],
        i18n: {
          en: {
            title: 'Athena IA ðŸ§ ',
            subtitle: "Sua Monitora do IA Revolution!",
            inputPlaceholder: "Digite sua dÃºvida aquiâ€¦",
          }
        }
      });

      /* =======================================
         SEU CÃ“DIGO DE CUSTOMIZAÃ‡ÃƒO ORIGINAL
       ======================================= */
      // ... (todo o seu cÃ³digo com setTimeout, observers, etc., continua aqui, sem alteraÃ§Ãµes)
      setTimeout(removePoweredByN8n, 100);
      setTimeout(removePoweredByN8n, 500);
      setTimeout(removePoweredByN8n, 1000);
      setTimeout(removePoweredByN8n, 2000);
      const observer = new MutationObserver(function(mutations) {
        let shouldCheck = false;
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            shouldCheck = true;
          }
        });
        if (shouldCheck) {
          setTimeout(removePoweredByN8n, 100);
        }
      });
      setTimeout(() => {
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          observer.observe(chatContainer, {
            childList: true,
            subtree: true
          });
        }
      }, 1000);
      setTimeout(() => {
        const toggleButton = document.querySelector('.chat__toggle');
        if (toggleButton) {
          const svgIcon = toggleButton.querySelector('svg');
          if (svgIcon) {
            svgIcon.style.marginRight = '10px';
          }
          const textSpan = document.createElement('span');
          textSpan.textContent = 'Tire DÃºvidas com IA';
          textSpan.style.color = 'white';
          textSpan.style.fontSize = '14px';
          textSpan.style.fontWeight = '500';
          textSpan.style.fontFamily = "'Poppins', sans-serif";
          toggleButton.appendChild(textSpan);
          toggleButton.style.display = 'flex';
          toggleButton.style.alignItems = 'center';
          toggleButton.style.justifyContent = 'center';
          toggleButton.style.width = 'auto';
          toggleButton.style.minWidth = '180px';
          toggleButton.style.borderRadius = '30px';
          toggleButton.style.padding = '0 20px';
          toggleButton.style.fontFamily = "'Poppins', sans-serif";
        }
        removePoweredByN8n();
      }, 1000);
      setTimeout(() => {
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          chatContainer.addEventListener('click', function(e) {
            const sendButton = e.target.closest('[data-testid="send-button"], .chat__input-send-button, button.svelte-1omdpz4');
            if (sendButton) {
              const input = chatContainer.querySelector('input.svelte-1omdpz4, textarea.svelte-1omdpz4');
              if (input && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);
          chatContainer.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              const input = e.target;
              if (input && (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);
        }
      }, 1500);
    </script>
</body>
</html>