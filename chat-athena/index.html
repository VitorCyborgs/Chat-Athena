<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Revolution</title>

    <script>
      const nomeModuloEstatico = 'agente_de_ia_com_n8n';
    </script>

    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
      /* ===== SEU CSS ORIGINAL COMPLETO ===== */
      :root {
        /* --- CORES PRINCIPAIS --- */
        --chat--color-primary: #7C00FF;
        --chat--color-primary-shade-50: #6B00E6;
        --chat--color-primary-shade-100: #5A00CC;
        --chat--color-secondary: #7C00FF;
        --chat--color-secondary-shade-50: #6B00E6;
        --chat--color-dark: #7C00FF;
        --chat--color-light: #232323;
        --chat--color-white: #232323;
        --chat--color-light-shade-50: #2a2a2a;
        --chat--color-light-shade-100: #333333;
        --chat--color-medium: #404040;
        --chat--color-disabled: #777980;
        --chat--color-typing: #ffffff;
        /* ... e todo o resto do seu CSS original ... */
      }
    </style>
</head>
<body style="margin: 0;">

    <div id="iarev-chat"></div>

    <script type="module">
      // Importa a biblioteca do N8N Chat
      import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

      /* =======================================
         PREVENÇÃO DE MÚLTIPLAS INSTÂNCIAS
       ======================================= */
      if (window.__iarevChat) {
        window.__iarevChat.destroy?.();
      }

      /* =======================================
         CONFIGURAÇÃO DE METADADOS
       ======================================= */
      const slugify = (s) =>
        s
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .toLowerCase().replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "_");

      // Objeto de metadados agora começa com um valor padrão
      const metadata = {
        modulo: nomeModuloEstatico,
        aula: "aula_geral" // Valor inicial
      };

      // =====================================================================
      //  NOVO: RECEPTOR DE MENSAGENS DA PÁGINA DA CADEMY
      // =====================================================================
      window.addEventListener('message', function(event) {
        // Medida de segurança: apenas aceita mensagens vindas do seu domínio
        if (event.origin !== 'https://membros.iarevolution.com.br') {
            console.warn('Mensagem ignorada por segurança. Origem:', event.origin);
            return;
        }

        // Verifica se a mensagem tem o tipo e os dados que esperamos
        if (event.data && event.data.type === 'setAula') {
          console.log('Nome da aula recebido:', event.data.aula);
          
          // Atualiza o nome da aula no nosso objeto metadata
          metadata.aula = slugify(event.data.aula);
        }
      });
      // =====================================================================

      /* =======================================
         FUNÇÃO PARA REMOVER "Powered by n8n" (SEU CÓDIGO ORIGINAL)
       ======================================= */
      function removePoweredByN8n() {
        const footerElements = document.querySelectorAll('.chat__footer span, .chat__footer > span, span.svelte-15j5n1q');
        footerElements.forEach(el => {
          if (el.textContent.includes('Powered by') || el.textContent.includes('n8n')) {
            el.remove();
          }
        });
        const walker = document.createTreeWalker(document.getElementById('iarev-chat'), NodeFilter.SHOW_TEXT, null, false);
        let node;
        const nodesToRemove = [];
        while (node = walker.nextNode()) {
          if (node.textContent.includes('Powered by n8n')) {
            nodesToRemove.push(node.parentElement);
          }
        }
        nodesToRemove.forEach(el => {
          if (el) el.remove();
        });
        const footer = document.querySelector('.chat__footer');
        if (footer && footer.textContent.includes('Powered by')) {
          footer.innerHTML = '';
          footer.style.display = 'none';
        }
      }

      /* =======================================
         CRIAÇÃO E CONFIGURAÇÃO DO CHAT
       ======================================= */
      window.__iarevChat = createChat({
        target: "#iarev-chat",
        webhookUrl: "/api/chat-proxy",
        metadata, // Este objeto agora é dinâmico
        showWelcomeScreen: false,
        initialMessages: [
            "Olá! Sou a Athena, monitora do IA Revolution. Me fala qual é sua pergunta sobre essa aula, que vou te ajudar 😄"
        ],
        i18n: {
          en: {
            title: 'Athena IA 🧠',
            subtitle: "Sua Monitora do IA Revolution!",
            inputPlaceholder: "Digite sua dúvida aqui…",
          }
        }
      });

      /* =======================================
         SEU CÓDIGO ORIGINAL DE CUSTOMIZAÇÃO AVANÇADA
       ======================================= */
      setTimeout(removePoweredByN8n, 100);
      setTimeout(removePoweredByN8n, 500);
      setTimeout(removePoweredByN8n, 1000);
      setTimeout(removePoweredByN8n, 2000);
      const observer = new MutationObserver(function(mutations) {
        let shouldCheck = false;
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            shouldCheck = true;
          }
        });
        if (shouldCheck) {
          setTimeout(removePoweredByN8n, 100);
        }
      });
      setTimeout(() => {
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          observer.observe(chatContainer, {
            childList: true,
            subtree: true
          });
        }
      }, 1000);
      setTimeout(() => {
        const toggleButton = document.querySelector('.chat__toggle');
        if (toggleButton) {
          const svgIcon = toggleButton.querySelector('svg');
          if (svgIcon) {
            svgIcon.style.marginRight = '10px';
          }
          const textSpan = document.createElement('span');
          textSpan.textContent = 'Tire Dúvidas com IA';
          textSpan.style.color = 'white';
          textSpan.style.fontSize = '14px';
          textSpan.style.fontWeight = '500';
          textSpan.style.fontFamily = "'Poppins', sans-serif";
          toggleButton.appendChild(textSpan);
          toggleButton.style.display = 'flex';
          toggleButton.style.alignItems = 'center';
          toggleButton.style.justifyContent = 'center';
          toggleButton.style.width = 'auto';
          toggleButton.style.minWidth = '180px';
          toggleButton.style.borderRadius = '30px';
          toggleButton.style.padding = '0 20px';
          toggleButton.style.fontFamily = "'Poppins', sans-serif";
        }
        removePoweredByN8n();
      }, 1000);
      setTimeout(() => {
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          chatContainer.addEventListener('click', function(e) {
            const sendButton = e.target.closest('[data-testid="send-button"], .chat__input-send-button, button.svelte-1omdpz4');
            if (sendButton) {
              const input = chatContainer.querySelector('input.svelte-1omdpz4, textarea.svelte-1omdpz4');
              if (input && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);
          chatContainer.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              const input = e.target;
              if (input && (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);
        }
      }, 1500);
    </script>
</body>
</html>