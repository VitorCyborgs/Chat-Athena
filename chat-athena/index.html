<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Revolution</title>
    <script>
      const nomeModuloEstatico = 'agente_de_ia_com_n8n';
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      /* Seu CSS completo e original vai aqui */
      :root { --chat--color-primary: #7C00FF; /* etc... */ }
      /* ... todo o resto do seu CSS ... */
    </style>
</head>
<body style="margin: 0;">

    <div id="iarev-chat"></div>

    <script type="module">
      import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

      if (window.__iarevChat) {
        window.__iarevChat.destroy?.();
      }

      const slugify = (s) => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "_");
      
      const metadata = {
        modulo: nomeModuloEstatico,
        aula: "aula_geral"
      };

      // RECEPTOR DE MENSAGENS DA PÁGINA PRINCIPAL
      window.addEventListener('message', function(event) {
        // =====================================================================
        //  A CORREÇÃO ESTÁ AQUI!
        //  Agora verificamos a origem exata do seu site.
        // =====================================================================
        if (event.origin !== 'https://membros.iarevolution.com.br') {
            return; // Ignora mensagens de qualquer outra origem
        }

        if (event.data && event.data.type === 'setAula') {
          metadata.aula = slugify(event.data.aula);
        }
      });

      // ... (O resto do seu código original, como a função removePoweredByN8n e createChat, continua aqui, sem alterações)
      function removePoweredByN8n() { /* ... seu código ... */ }
      window.__iarevChat = createChat({ /* ... sua configuração ... */ });
      // ... (seus setTimeouts, observers, etc., continuam aqui)
    </script>
</body>
</html>